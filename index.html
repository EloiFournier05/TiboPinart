<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Tibo Pinart ‚Äì V1</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #0d0d0d;
      --bg-card: #1f1f1f;
      --bg-card-soft: #151515;
      --border: #2b2b2b;
      --text: #ffffff;
      --text-muted: #9e9e9e;
      --yellow: #ffd600;
      --green: #00a85a;
      --red: #d7263d;
      --white-maillot: #f6f6f6;
      --accent: #ffb100;
      --danger: #ff4337;
      --radius: 12px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      background: var(--bg);
      color: var(--text);
      padding: 8px;
    }

    .app {
      max-width: 480px;
      margin: 0 auto;
    }

    /* HEADER */

    .header {
      background: var(--bg-card);
      border-radius: var(--radius);
      border: 1px solid var(--border);
      padding: 10px 14px;
      margin-bottom: 8px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .header-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .timer-label {
      font-size: 0.75rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    .timer-value {
      font-variant-numeric: tabular-nums;
      font-size: 1.4rem;
      font-weight: 700;
    }

    .settings-btn {
      border: none;
      background: transparent;
      color: var(--text-muted);
      font-size: 1.4rem;
      padding: 4px;
      cursor: pointer;
    }

    .next-event {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .room-code {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      padding: 6px 8px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--bg-card-soft);
      font-size: 0.85rem;
    }

    .room-code span {
      font-weight: 700;
      color: var(--yellow);
      letter-spacing: 0.1em;
    }

    .btn-copy {
      border: 1px solid var(--border);
      background: transparent;
      color: var(--text-muted);
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 0.75rem;
      cursor: pointer;
    }

    /* JOUEURS */

    .players-card {
      background: var(--bg-card);
      border-radius: var(--radius);
      border: 1px solid var(--border);
      padding: 6px 0;
      margin-bottom: 10px;
    }

    .player-row {
      padding: 8px 12px;
      border-bottom: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .player-row:last-child {
      border-bottom: none;
    }

    .player-top-line {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .player-rank {
      font-size: 0.9rem;
      color: var(--text-muted);
      margin-right: 6px;
      min-width: 1.5rem;
    }

    .player-name {
      font-weight: 600;
      font-size: 1rem;
    }

    .player-incidents {
      font-size: 0.9rem;
      color: var(--danger);
      margin-left: 4px;
    }

    .player-maillots {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 0.8rem;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 3px;
      padding: 2px 6px;
      border-radius: 999px;
      font-variant-numeric: tabular-nums;
      font-size: 0.75rem;
      border: 1px solid var(--border);
      background: var(--bg-card-soft);
    }

    .badge-yellow-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--yellow);
    }

    .badge-green-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--green);
    }

    .badge-red-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--red);
    }

    .badge-white-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--white-maillot);
    }

    .player-actions {
      display: flex;
      justify-content: flex-end;
      margin-top: 2px;
    }

    .btn-fini {
      font-size: 0.8rem;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--yellow);
      background: rgba(255, 214, 0, 0.08);
      color: var(--yellow);
      cursor: pointer;
    }

    .btn-fini:disabled {
      opacity: 0.5;
      cursor: default;
    }

    /* ZONE √âV√âNEMENT */

    .event-zone {
      min-height: 60px;
      border-radius: var(--radius);
      border: 1px dashed var(--border);
      padding: 8px 10px;
      background: #101010;
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .event-title {
      font-weight: 600;
      margin-bottom: 4px;
      color: var(--text);
    }

    .event-body {
      line-height: 1.3;
      white-space: pre-line;
    }

    /* SETUP MODAL */

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 20;
    }

    .modal {
      background: var(--bg-card);
      border-radius: 16px;
      border: 1px solid var(--border);
      padding: 16px 14px 18px;
      width: 100%;
      max-width: 420px;
      max-height: 90vh;
      overflow-y: auto;
      box-sizing: border-box;
    }

    .modal h1 {
      font-size: 1.3rem;
      margin-bottom: 4px;
    }

    .modal p {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-bottom: 12px;
    }

    .form-group {
      margin-bottom: 12px;
    }

    .form-label {
      display: block;
      font-size: 0.8rem;
      margin-bottom: 4px;
      color: var(--text-muted);
    }

    .form-input, .form-select, .form-textarea {
      width: 100%;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--bg-card-soft);
      color: var(--text);
      padding: 6px 8px;
      font-size: 0.9rem;
    }

    .form-textarea {
      min-height: 100px;
      resize: vertical;
    }

    .btn-primary {
      width: 100%;
      border-radius: 999px;
      padding: 8px 12px;
      border: none;
      background: linear-gradient(135deg, var(--yellow), var(--accent));
      color: #000;
      font-weight: 700;
      font-size: 0.95rem;
      cursor: pointer;
      margin-top: 4px;
    }

    .btn-secondary {
      width: 100%;
      border-radius: 999px;
      padding: 8px 12px;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--text-muted);
      font-size: 0.85rem;
      cursor: pointer;
      margin-top: 6px;
    }

    .error-text {
      color: var(--danger);
      font-size: 0.8rem;
      margin-top: 4px;
    }

    /* Contenu principal cach√© au d√©but */
    #main-content {
      display: none;
    }

    #player-content {
      display: none;
    }

    .mode-buttons {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      justify-content: center;
      margin-top: 20px;
    }

    .mode-buttons .btn-primary {
      width: auto;
      min-width: 160px;
      font-size: 1.1rem;
      padding: 12px 18px;
    }

    .config-link {
      margin-top: 14px;
      font-size: 0.85rem;
      color: #f6f6f6;
      text-decoration: underline;
      cursor: pointer;
      background: transparent;
      border: none;
    }

    .player-card {
      background: var(--bg-card);
      border-radius: var(--radius);
      border: 1px solid var(--border);
      padding: 16px;
      margin-top: 20px;
    }

    .player-finish {
      width: 100%;
      border-radius: 16px;
      padding: 18px 12px;
      font-size: 1.4rem;
      font-weight: 800;
      background: linear-gradient(135deg, var(--yellow), var(--accent));
      color: #000;
      border: none;
      cursor: pointer;
      margin-top: 14px;
    }

    .player-status {
      margin-top: 10px;
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .corrections-card {
      background: var(--bg-card);
      border-radius: var(--radius);
      border: 1px solid var(--border);
      padding: 10px 12px;
      margin-top: 10px;
      display: none;
      font-size: 0.8rem;
    }

    .corrections-row {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr 1fr auto;
      gap: 6px;
      align-items: center;
      padding: 6px 0;
      border-bottom: 1px solid var(--border);
    }

    .corrections-row:last-child {
      border-bottom: none;
    }

    .corrections-row input {
      width: 100%;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: var(--bg-card-soft);
      color: var(--text);
      padding: 4px 6px;
      font-size: 0.8rem;
    }

    .corrections-row button {
      border: 1px solid var(--border);
      background: transparent;
      color: var(--yellow);
      border-radius: 999px;
      padding: 4px 8px;
      font-size: 0.75rem;
      cursor: pointer;
    }

    @media (max-width: 360px) {
      .player-maillots {
        flex-wrap: wrap;
      }
    }

    @media (max-width: 600px) {
      #cover-screen {
        height: 100vh !important;
        overflow: hidden !important;
        background-size: contain !important;
        background-position: top center !important;
        background-repeat: no-repeat !important;
        background-color: #000;
      }
    }
  </style>
</head>
<body>
<!-- √âCRAN DE COUVERTURE + MODE -->
<div id="cover-screen" style="
  position:fixed;
  top:0; left:0; width:100%; height:100%;
  background: url('https://i.imgur.com/eva8EXh.png') center/cover no-repeat;
  background-color: rgba(0,0,0,0.25);
  background-blend-mode: darken;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  z-index:2000;
  color:white;
  text-align:center;
  padding:20px;
  transition: opacity 0.4s ease;
">
  <h1 style="
    font-size:3rem;
    margin-bottom:10px;
    letter-spacing:2px;
    font-weight:900;
    text-shadow:0 0 10px #000;
  ">TIBO PINART</h1>

  <h2 style="
    font-size:1.4rem;
    margin-bottom:10px;
    opacity:0.95;
    font-weight:600;
    text-shadow:0 0 10px #000;
  ">Le Tour du Bar</h2>

  <div style="font-size:0.9rem; color:#f6f6f6; text-shadow:0 0 10px #000;">
    Choisis ton mode
  </div>

  <div class="mode-buttons">
    <button id="btn-mode-host" class="btn-primary" style="background:#ffd60a;">Mode Host</button>
    <button id="btn-mode-player" class="btn-primary" style="background:#ffffff; color:#000;">Mode Player</button>
  </div>

  <button id="btn-config-supabase" class="config-link" type="button">
    Configurer Supabase
  </button>
</div>

<div id="main-content">
  <div class="app">
    <header class="header">
      <div class="header-top">
        <div>
          <div class="timer-label">Temps restant</div>
          <div class="timer-value" id="timer">--:--:--</div>
          <div id="next-event" class="next-event">Prochain √©v√©nement : chargement‚Ä¶</div>
        </div>
        <button class="settings-btn" id="btn-settings" title="Menu (non actif pour la V1)">‚öô</button>
      </div>
      <div class="room-code" id="room-code">
        Code salle : <span id="room-code-value">‚Äî</span>
        <button class="btn-copy" id="btn-copy-room">Copier</button>
      </div>
      <div class="next-event" id="supabase-warning" style="display:none;">
        Supabase non configur√©, le mode Player est d√©sactiv√©.
      </div>
      <div class="next-event" id="supabase-status" style="display:none;"></div>
    </header>

    <section class="players-card" id="players-card">
      <!-- Lignes joueurs g√©n√©r√©es par JS -->
    </section>

    <section class="players-card" id="teams-card" style="display:none; margin-top:8px;">
      <!-- Remplie par JS -->
    </section>

    <div style="text-align:center; margin-bottom:10px;">
      <button id="btn-sprint" class="btn-primary" style="width:auto; padding:8px 20px; font-size:1rem;">
        ‚ö° SPRiNT !
      </button>

      <button id="btn-cote" class="btn-primary" style="width:auto; padding:8px 20px; font-size:1rem; background:#7E57C2; margin-left:6px;">
        ‚õ∞Ô∏è C√¥te
      </button>

      <button id="btn-echappee" class="btn-primary" style="width:auto; padding:8px 20px; font-size:1rem; background:#F5F5F5; color:#000; margin-left:6px;">
        üö¥ √âchapp√©e
      </button>

      <button id="btn-incident" class="btn-primary" style="width:auto; padding:8px 20px; font-size:1rem; background:#d7263d; margin-left:6px;">
        ‚ö†Ô∏è Incident
      </button>
    </div>

    <section class="event-zone" id="event-zone">
      <div class="event-title">Aucun √©v√©nement en cours</div>
      <div class="event-body">
        Quand une pinte est termin√©e, appuie sur ¬´ Fini ¬ª pour enregistrer le temps et mettre √† jour le Maillot Jaune.
      </div>
    </section>

    <section class="corrections-card" id="corrections-card">
      <div class="event-title" style="margin-bottom:6px;">Corrections temps (derni√®re √©tape)</div>
      <div class="corrections-row" style="font-weight:600; color:var(--text-muted);">
        <div>Joueur</div>
        <div>Heure r√©elle</div>
        <div>Temps derni√®re √©tape</div>
        <div>Temps retenu (s)</div>
        <div></div>
      </div>
      <div id="corrections-body"></div>
    </section>
  </div>

  <!-- MODAL SETUP INITIAL -->
  <div class="modal-backdrop" id="setup-modal">
    <div class="modal">
      <h1>Tibo Pinart</h1>
      <p>Jeu de bar inspir√© du Tour de France. Un t√©l√©phone au centre, des pintes, des maillots.</p>

      <div class="form-group">
        <label class="form-label" for="tour-duration">Dur√©e du Tour</label>
        <select id="tour-duration" class="form-select">
          <option value="60">1h</option>
          <option value="120">2h</option>
          <option value="180" selected>3h</option>
          <option value="240">4h</option>
          <option value="300">5h</option>
        </select>
        <div style="margin-top:12px;">
          <span style="font-weight:600;">Profil de l'√©tape</span>
          <div style="margin-top:4px; font-size:0.9rem;">
            <label>
              <input type="radio" name="profil-etape" value="Ville" checked>
              Ville (soft)
            </label><br>
            <label>
              <input type="radio" name="profil-etape" value="Plaine">
              Plaine (medium)
            </label><br>
            <label>
              <input type="radio" name="profil-etape" value="Montagne">
              Montagne (hard)
            </label>
          </div>
        </div>
      </div>

      <div class="form-group">
        <label class="form-label" for="players-input">Pr√©noms des joueurs (un par ligne)</label>
        <textarea id="players-input" class="form-textarea" placeholder="Louis&#10;Eloi&#10;Gabriel&#10;Lo√Øc"></textarea>
      </div>

      <div class="form-group" style="margin-top:8px; border-top:1px solid var(--border); padding-top:8px;">
        <label class="form-label">Mode √©quipes (optionnel)</label>
        <label style="font-size:0.85rem; display:flex; align-items:center; gap:6px; margin-bottom:6px;">
          <input type="checkbox" id="teams-enabled" />
          Activer les √©quipes
        </label>

        <div id="teams-setup" style="display:none; margin-top:6px;">
          <div style="display:flex; gap:8px; margin-bottom:8px;">
            <div style="flex:1; border:1px solid var(--border); border-radius:8px; padding:6px;">
              <div style="font-size:0.8rem; margin-bottom:4px; font-weight:600;">√âquipe 1</div>
              <input id="team1-name" class="form-input" type="text" value="√âquipe 1" style="margin-bottom:4px;">
              <input id="team1-tag" class="form-input" type="text" value="EQ1" maxlength="3" style="margin-bottom:4px; text-transform:uppercase;">
              <label style="font-size:0.75rem; color:var(--text-muted);">Couleur</label>
              <input id="team1-color" type="color" value="#FFD600" style="width:100%; margin-top:2px;">
            </div>

            <div style="flex:1; border:1px solid var(--border); border-radius:8px; padding:6px;">
              <div style="font-size:0.8rem; margin-bottom:4px; font-weight:600;">√âquipe 2</div>
              <input id="team2-name" class="form-input" type="text" value="√âquipe 2" style="margin-bottom:4px;">
              <input id="team2-tag" class="form-input" type="text" value="EQ2" maxlength="3" style="margin-bottom:4px; text-transform:uppercase;">
              <label style="font-size:0.75rem; color:var(--text-muted);">Couleur</label>
              <input id="team2-color" type="color" value="#00AEEF" style="width:100%; margin-top:2px;">
            </div>
          </div>

          <button type="button" class="btn-secondary" id="btn-refresh-teams-assignment">
            Mettre √† jour la liste des joueurs
          </button>

          <div id="teams-assignment" style="margin-top:8px; font-size:0.8rem;">
            <div style="color:var(--text-muted);">
              Cliquez sur ¬´ Mettre √† jour la liste des joueurs ¬ª pour assigner chaque joueur √† une √©quipe.
            </div>
          </div>
        </div>
      </div>

      <button class="btn-primary" id="btn-start">Lancer le Tour</button>
      <div class="error-text" id="setup-error"></div>

      <button class="btn-secondary" id="btn-demo">Remplir un exemple</button>
    </div>
  </div>

  <div class="modal-backdrop" id="classement-modal" style="display:none;">
    <div class="modal">
      <h1>Classements</h1>
      <p>R√©sum√© des maillots et des points.</p>

      <div id="classement-content" style="max-height:60vh; overflow-y:auto; font-size:0.85rem;"></div>

      <button class="btn-secondary" id="btn-classement-close" style="margin-top:10px;">Fermer</button>
    </div>
  </div>
</div>

<div class="modal-backdrop" id="supabase-config-modal" style="display:none;">
  <div class="modal">
    <h1>Configurer Supabase</h1>
    <p>Collez votre URL Supabase et votre cl√© anon. Elles seront stock√©es en local sur cet appareil.</p>

    <div class="form-group">
      <label class="form-label" for="supabase-url-input">Supabase URL</label>
      <input id="supabase-url-input" class="form-input" type="text" placeholder="https://xxxx.supabase.co" />
    </div>

    <div class="form-group">
      <label class="form-label" for="supabase-key-input">Supabase anon key</label>
      <input id="supabase-key-input" class="form-input" type="text" placeholder="eyJhbGciOi..." />
    </div>

    <button class="btn-primary" id="btn-save-supabase">Enregistrer</button>
    <button class="btn-secondary" id="btn-close-supabase">Fermer</button>
    <div class="error-text" id="supabase-config-error"></div>
  </div>
</div>

<div id="player-content">
  <div class="app">
    <header class="header">
      <div class="timer-label">Mode Player</div>
      <div class="next-event">Partage ton code salle avec le Host.</div>
    </header>

    <div class="player-card">
      <div class="form-group">
        <label class="form-label" for="player-room-code">Code salle</label>
        <input id="player-room-code" class="form-input" type="text" placeholder="ABC123" />
      </div>
      <div class="form-group">
        <label class="form-label" for="player-name">Pr√©nom</label>
        <input id="player-name" class="form-input" type="text" placeholder="Camille" />
      </div>
      <button id="btn-player-join" class="btn-primary">Rejoindre la salle</button>
      <div class="player-status" id="player-status"></div>
      <button id="btn-player-finish" class="player-finish" style="display:none;">J‚Äôai fini ma pinte</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  // === SUPABASE CONFIG ===
  // Remplacez ces placeholders avant d√©ploiement (Vercel -> Variables d‚Äôenvironnement).
  // Pour une version statique, d√©finissez window.SUPABASE_URL et window.SUPABASE_ANON_KEY avant ce script.
  function loadSupabaseConfig() {
    const storedUrl = localStorage.getItem("supabaseUrl");
    const storedKey = localStorage.getItem("supabaseAnonKey");
    const metaUrl = document.querySelector('meta[name="supabase-url"]')?.content;
    const metaKey = document.querySelector('meta[name="supabase-anon-key"]')?.content;

    return {
      url: window.SUPABASE_URL || metaUrl || storedUrl || "YOUR_SUPABASE_URL",
      anonKey: window.SUPABASE_ANON_KEY || metaKey || storedKey || "YOUR_SUPABASE_ANON_KEY"
    };
  }

  let SUPABASE_CONFIG = loadSupabaseConfig();

  function isSupabaseReady(config) {
    return config.url && config.anonKey &&
      !config.url.includes("YOUR_SUPABASE") &&
      !config.anonKey.includes("YOUR_SUPABASE");
  }

  let supabaseReady = isSupabaseReady(SUPABASE_CONFIG);
  let supabaseClient = supabaseReady ? supabase.createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.anonKey) : null;

  const state = {
    joueurs: [],
    dureeMinutes: 180,
    tourFinTimestamp: null,
    tourStartTimestamp: null,
    stageStartTimestamp: null,
    timerInterval: null,
    pinteEnCours: true,
    finPinteOrdre: [],
    numeroPinte: 1,
    difficulte: "Plaine",
    timelineEvents: [],
    teams: [],
    roomId: null,
    roomCode: null,
    roomSubscription: null,
    eventSubscription: null,
    dataMode: "events",
    memberNameCache: new Map(),
    finishSignals: new Set(),
    lastStageIndex: 0
  };

  let sprintActif = false;
  let sprintCooldown = 0;
  let sprintLanceur = null;

  let coteActive = false;
  let coteCible = null;

  let echappeeActive = false;
  let echappeeClics = [];

  let incidentActif = false;
  let incidentData = null;

  const incidentsList = [
    { id: 1, type: "player", label: "Pas de main droite", duration: "1-pinte" },
    { id: 2, type: "player", label: "Pas de main gauche", duration: "1-pinte" },
    { id: 3, type: "player", label: "Boire debout", duration: "1-pinte" },
    { id: 4, type: "all", label: "Tout le monde change de place", duration: "instant" },
    { id: 5, type: "player", label: "Boire sans poser le verre", duration: "1-pinte" },
    { id: 6, type: "player", label: "Main sur la t√™te en buvant", duration: "1-pinte" },
    { id: 7, type: "player", label: "Doit annoncer '√Ä l‚Äôattaque !' avant chaque gorg√©e", duration: "1-pinte" },
    { id: 8, type: "all", label: "Tout le monde doit boire un verre d'eau", duration: "instant" },
    { id: 9, type: "player", label: "Interdiction de regarder le joueur choisi", duration: "5-min" },
    { id: 10, type: "player", label: "Accent impos√©", duration: "5-min" },
    { id: 11, type: "gameplay", label: "+5 secondes sur la prochaine pinte", duration: "1-pinte" },
    { id: 12, type: "gameplay", label: "Interdiction de lancer le prochain sprint", duration: "15-min" }
  ];

  const elTimer = document.getElementById("timer");
  const elNextEvent = document.getElementById("next-event");
  const elPlayersCard = document.getElementById("players-card");
  const elEventZone = document.getElementById("event-zone");
  const elSetupModal = document.getElementById("setup-modal");
  const elDuration = document.getElementById("tour-duration");
  const elPlayersInput = document.getElementById("players-input");
  const elSetupError = document.getElementById("setup-error");
  const elBtnStart = document.getElementById("btn-start");
  const elBtnDemo = document.getElementById("btn-demo");
  const elClassementModal = document.getElementById("classement-modal");
  const elClassementContent = document.getElementById("classement-content");
  const elBtnClassementClose = document.getElementById("btn-classement-close");
  const elBtnSettings = document.getElementById("btn-settings");
  const elTeamsCard = document.getElementById("teams-card");
  const elCorrectionsCard = document.getElementById("corrections-card");
  const elCorrectionsBody = document.getElementById("corrections-body");

  const elTeamsEnabled = document.getElementById("teams-enabled");
  const elTeam1Name = document.getElementById("team1-name");
  const elTeam1Tag = document.getElementById("team1-tag");
  const elTeam1Color = document.getElementById("team1-color");
  const elTeam2Name = document.getElementById("team2-name");
  const elTeam2Tag = document.getElementById("team2-tag");
  const elTeam2Color = document.getElementById("team2-color");
  const elTeamsAssignment = document.getElementById("teams-assignment");
  const elBtnRefreshTeams = document.getElementById("btn-refresh-teams-assignment");
  const elTeamsSetup = document.getElementById("teams-setup");

  const elCoverScreen = document.getElementById("cover-screen");
  const elBtnModeHost = document.getElementById("btn-mode-host");
  const elBtnModePlayer = document.getElementById("btn-mode-player");
  const elMainContent = document.getElementById("main-content");
  const elPlayerContent = document.getElementById("player-content");
  const elSupabaseWarning = document.getElementById("supabase-warning");
  const elSupabaseStatus = document.getElementById("supabase-status");
  const elRoomCodeValue = document.getElementById("room-code-value");
  const elCopyRoom = document.getElementById("btn-copy-room");

  const elPlayerRoomCode = document.getElementById("player-room-code");
  const elPlayerName = document.getElementById("player-name");
  const elBtnPlayerJoin = document.getElementById("btn-player-join");
  const elBtnPlayerFinish = document.getElementById("btn-player-finish");
  const elPlayerStatus = document.getElementById("player-status");

  const elSupabaseConfigModal = document.getElementById("supabase-config-modal");
  const elSupabaseUrlInput = document.getElementById("supabase-url-input");
  const elSupabaseKeyInput = document.getElementById("supabase-key-input");
  const elSupabaseConfigError = document.getElementById("supabase-config-error");
  const elBtnConfigSupabase = document.getElementById("btn-config-supabase");
  const elBtnSaveSupabase = document.getElementById("btn-save-supabase");
  const elBtnCloseSupabase = document.getElementById("btn-close-supabase");

  const sndSprint = document.getElementById("snd-sprint");
  const sndCote = document.getElementById("snd-cote");
  const sndEchappee = document.getElementById("snd-echappee");
  const sndIncident = document.getElementById("snd-incident");

  function formatTimeHMS(totalSeconds) {
    if (totalSeconds < 0) totalSeconds = 0;
    const h = Math.floor(totalSeconds / 3600);
    const m = Math.floor((totalSeconds % 3600) / 60);
    const s = Math.floor(totalSeconds % 60);
    const pad = (x) => x.toString().padStart(2, "0");
    return `${pad(h)}:${pad(m)}:${pad(s)}`;
  }

  function formatDeltaSeconds(sec) {
    const sign = sec >= 0 ? "+" : "-";
    const abs = Math.abs(sec);
    const sInt = Math.floor(abs);
    const centi = Math.round((abs - sInt) * 100);
    return `${sign}${sInt}\"${centi.toString().padStart(2, "0")}`;
  }

  function formatClockTime(timestampSeconds) {
    if (!timestampSeconds) return "--:--";
    const date = new Date(timestampSeconds * 1000);
    return date.toLocaleTimeString("fr-FR", {
      hour: "2-digit",
      minute: "2-digit",
      second: "2-digit"
    });
  }

  function formatSecondsShort(seconds) {
    if (seconds === null || seconds === undefined) return "--";
    const s = Math.max(0, Math.round(seconds));
    const m = Math.floor(s / 60);
    const r = s % 60;
    if (m === 0) return `${r}s`;
    return `${m}m ${r.toString().padStart(2, "0")}s`;
  }

  function nowSeconds() {
    return Date.now() / 1000;
  }

  function generateRoomCode(length = 6) {
    const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
    let out = "";
    for (let i = 0; i < length; i += 1) {
      out += chars[Math.floor(Math.random() * chars.length)];
    }
    return out;
  }

  function setEventZone(title, body) {
    let titleEl = elEventZone.querySelector(".event-title");
    let bodyEl = elEventZone.querySelector(".event-body");

    if (!titleEl || !bodyEl) {
      elEventZone.innerHTML = `
        <div class="event-title"></div>
        <div class="event-body"></div>
      `;
      titleEl = elEventZone.querySelector(".event-title");
      bodyEl = elEventZone.querySelector(".event-body");
    }

    if (titleEl) titleEl.textContent = title;
    if (bodyEl) bodyEl.textContent = body;
  }

  function showSupabaseError(message) {
    if (elSupabaseStatus) {
      elSupabaseStatus.textContent = message;
      elSupabaseStatus.style.display = "block";
    }
    setEventZone("Supabase", message);
  }

  function getFinishKey(name) {
    return `${state.numeroPinte}:${(name || "").trim().toLowerCase()}`;
  }

  function recordFinish(name) {
    const key = getFinishKey(name);
    if (!key || key.endsWith(":")) return false;
    if (state.finishSignals.has(key)) return false;
    state.finishSignals.add(key);
    return true;
  }

  async function ensureSignedIn() {
    if (!supabaseClient) return null;
    const { data: sessionData } = await supabaseClient.auth.getSession();
    if (sessionData?.session) return sessionData.session;

    const { data, error } = await supabaseClient.auth.signInAnonymously();
    if (error) {
      throw error;
    }
    return data.session;
  }

  function playSound(type) {
    let audio = null;
    if (type === "SPRINT") audio = sndSprint;
    if (type === "COTE") audio = sndCote;
    if (type === "ECHAPPEE") audio = sndEchappee;
    if (type === "INCIDENT") audio = sndIncident;

    if (audio) {
      audio.currentTime = 0;
      audio.play().catch(() => {});
    }
  }

  function refreshTeamsAssignmentUI() {
    if (!elTeamsAssignment) return;

    const rawNames = elPlayersInput.value
      .split("\n")
      .map((s) => s.trim())
      .filter((s) => s.length > 0);

    if (rawNames.length === 0) {
      elTeamsAssignment.innerHTML =
        '<div style="color:var(--text-muted);">Ajoutez d\'abord des joueurs dans la liste au-dessus.</div>';
      return;
    }

    let html = '<div style="margin-top:4px;">';
    rawNames.forEach((name, idx) => {
      const idSelect = `team-assign-${idx}`;
      html += `
        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:4px;">
          <span>${name}</span>
          <select id="${idSelect}" class="form-select" style="max-width:150px;">
            <option value="">Aucune √©quipe</option>
            <option value="1">√âquipe 1</option>
            <option value="2">√âquipe 2</option>
          </select>
        </div>
      `;
    });
    html += "</div>";

    elTeamsAssignment.innerHTML = html;
  }

  function computeOccurrences(dureeMinutes, difficulte) {
    const H = dureeMinutes / 60;
    let sprints, cotes, echappees, incidents;

    if (difficulte === "Ville") {
      sprints = 1 * H;
      cotes = Math.max(1, Math.round(0.5 * H));
      echappees = Math.round(1.5 * H);
      incidents = 2 * H;
    } else if (difficulte === "Plaine") {
      sprints = 2 * H;
      cotes = 1 * H;
      echappees = 3 * H;
      incidents = 4 * H;
    } else if (difficulte === "Montagne") {
      sprints = 3 * H;
      cotes = 2 * H;
      echappees = 4 * H;
      incidents = 6 * H;
    } else {
      sprints = 2 * H;
      cotes = 1 * H;
      echappees = 3 * H;
      incidents = 4 * H;
    }

    return {
      sprints: Math.max(1, Math.round(sprints)),
      cotes: Math.max(1, Math.round(cotes)),
      echappees: Math.max(1, Math.round(echappees)),
      incidents: Math.max(1, Math.round(incidents))
    };
  }

  function shuffleArray(arr) {
    const a = [...arr];
    for (let i = a.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
  }

  function buildTimeline(dureeMinutes, occurrences) {
    const totalSeconds = dureeMinutes * 60;
    const events = [];

    for (let i = 0; i < occurrences.sprints; i++) events.push("SPRINT");
    for (let i = 0; i < occurrences.cotes; i++) events.push("COTE");
    for (let i = 0; i < occurrences.echappees; i++) events.push("ECHAPPEE");
    for (let i = 0; i < occurrences.incidents; i++) events.push("INCIDENT");

    if (events.length === 0) return [];

    const shuffled = shuffleArray(events);
    const N = shuffled.length;
    const slotSize = totalSeconds / N;

    const timeline = [];

    for (let i = 0; i < N; i++) {
      const base = i * slotSize;
      const t = base + Math.random() * slotSize;
      timeline.push({
        timeOffset: t,
        type: shuffled[i],
        fired: false
      });
    }

    timeline.sort((a, b) => a.timeOffset - b.timeOffset);

    return timeline;
  }

  function describeEventType(type) {
    if (type === "SPRINT") return "Sprint (maillot vert)";
    if (type === "COTE") return "C√¥te (maillot √† pois)";
    if (type === "ECHAPPEE") return "√âchapp√©e (maillot blanc)";
    if (type === "INCIDENT") return "Incident de course";
    return type;
  }

  function updateNextEventLabel() {
    if (!elNextEvent) return;

    if (!state.timelineEvents || state.timelineEvents.length === 0 || !state.tourStartTimestamp) {
      elNextEvent.textContent = "Prochain √©v√©nement : aucun";
      return;
    }

    const now = nowSeconds();
    const elapsed = now - state.tourStartTimestamp;

    const next = state.timelineEvents.find((ev) => !ev.fired && ev.timeOffset > elapsed);

    if (!next) {
      elNextEvent.textContent = "Prochain √©v√©nement : aucun (fin du Tour)";
      return;
    }

    const secondsToGo = Math.max(0, Math.round(next.timeOffset - elapsed));
    const minutes = Math.floor(secondsToGo / 60);
    const secs = secondsToGo % 60;

    const tStr = minutes > 0
      ? `${minutes} min ${secs.toString().padStart(2, "0")} s`
      : `${secs} s`;

    elNextEvent.textContent = `Prochain √©v√©nement : ${describeEventType(next.type)} dans ${tStr}`;
  }

  function isAnyEventActive() {
    return sprintActif || coteActive || echappeeActive || incidentActif;
  }

  function checkTimelineEvents() {
    if (!state.timelineEvents || state.timelineEvents.length === 0 || !state.tourStartTimestamp) {
      return;
    }

    if (isAnyEventActive()) {
      return;
    }

    const now = nowSeconds();
    const elapsed = now - state.tourStartTimestamp;

    state.timelineEvents.forEach((ev) => {
      if (!ev.fired && ev.timeOffset <= elapsed) {
        ev.fired = true;

        if (ev.type === "SPRINT") {
          if (!sprintActif) {
            sprintActif = true;
            sprintLanceur = null;
            renderSprintInterface();
            playSound("SPRINT");
          }
        } else if (ev.type === "COTE") {
          if (!coteActive) {
            coteActive = true;
            coteCible = Math.floor(20 + Math.random() * 60);
            renderCoteInterface();
            playSound("COTE");
          }
        } else if (ev.type === "ECHAPPEE") {
          if (!echappeeActive) {
            echappeeActive = true;
            echappeeClics = [];
            renderEchappeeInterface();
            playSound("ECHAPPEE");
          }
        } else if (ev.type === "INCIDENT") {
          if (!incidentActif) {
            incidentActif = true;
            incidentData = incidentsList[Math.floor(Math.random() * incidentsList.length)];
            renderIncidentInterface();
            playSound("INCIDENT");
          }
        }
      }
    });

    cleanExpiredIncidents();
  }

  function tickTimer() {
    const remaining = Math.floor(state.tourFinTimestamp - nowSeconds());

    if (remaining <= 0) {
      clearInterval(state.timerInterval);
      elTimer.textContent = "00:00:00";
      endTour();
    } else {
      elTimer.textContent = formatTimeHMS(remaining);
    }

    updateNextEventLabel();
    checkTimelineEvents();
  }

  function ouvrirClassements() {
    if (state.joueurs.length === 0) {
      elClassementContent.innerHTML = "<p>Aucun joueur pour l'instant.</p>";
      elClassementModal.style.display = "flex";
      return;
    }

    const joueurs = [...state.joueurs];

    const jaune = [...joueurs].sort((a, b) => a.tempsCumul√© - b.tempsCumul√©);
    const leaderJaune = jaune[0].tempsCumul√©;

    const vert = [...joueurs].sort((a, b) => b.pointsVert - a.pointsVert);
    const pois = [...joueurs].sort((a, b) => b.pointsPois - a.pointsPois);
    const blanc = [...joueurs].sort((a, b) => b.pointsBlanc - a.pointsBlanc);

    let html = "";

    html += '<h3 style="margin:6px 0;">üü° Maillot Jaune</h3>';
    html += '<ul style="list-style:none; padding-left:0; margin:0 0 8px 0;">';
    jaune.slice(0, 3).forEach((j, idx) => {
      const delta = j.tempsCumul√© - leaderJaune;
      const deltaStr = idx === 0 ? "leader" : formatDeltaSeconds(delta);
      html += `<li>${idx + 1}. <b>${j.nom}</b> ‚Äì ${deltaStr}</li>`;
    });
    html += "</ul>";

    html += '<h3 style="margin:6px 0;">üü¢ Maillot Vert</h3>';
    html += '<ul style="list-style:none; padding-left:0; margin:0 0 8px 0;">';
    vert.slice(0, 3).forEach((j, idx) => {
      html += `<li>${idx + 1}. <b>${j.nom}</b> ‚Äì ${j.pointsVert} pts</li>`;
    });
    html += "</ul>";

    html += '<h3 style="margin:6px 0;">üî¥ Maillot √† Pois</h3>';
    html += '<ul style="list-style:none; padding-left:0; margin:0 0 8px 0;">';
    pois.slice(0, 3).forEach((j, idx) => {
      html += `<li>${idx + 1}. <b>${j.nom}</b> ‚Äì ${j.pointsPois} pts</li>`;
    });
    html += "</ul>";

    html += '<h3 style="margin:6px 0;">‚ö™ Maillot Blanc</h3>';
    html += '<ul style="list-style:none; padding-left:0; margin:0;">';
    blanc.slice(0, 3).forEach((j, idx) => {
      html += `<li>${idx + 1}. <b>${j.nom}</b> ‚Äì ${j.pointsBlanc} pts</li>`;
    });
    html += "</ul>";

    elClassementContent.innerHTML = html;
    elClassementModal.style.display = "flex";
  }

  function endTour() {
    setEventZone(
      "Fin du Tour",
      "Le temps est √©coul√©. Le Maillot Jaune est attribu√© au joueur avec le plus petit temps cumul√©. Les autres maillots seront g√©r√©s dans une prochaine version."
    );
    const buttons = document.querySelectorAll(".btn-fini");
    buttons.forEach((b) => (b.disabled = true));
  }

  function renderPlayers() {
    const sorted = [...state.joueurs].sort((a, b) => a.tempsCumul√© - b.tempsCumul√©);

    elPlayersCard.innerHTML = "";

    const leader = sorted.length > 0 ? sorted[0].tempsCumul√© : 0;

    sorted.forEach((j, index) => {
      const row = document.createElement("div");
      row.className = "player-row";

      const topLine = document.createElement("div");
      topLine.className = "player-top-line";

      const left = document.createElement("div");
      left.style.display = "flex";
      left.style.alignItems = "center";

      const rank = document.createElement("div");
      rank.className = "player-rank";
      rank.textContent = `${index + 1}.`;
      left.appendChild(rank);

      const name = document.createElement("div");
      name.className = "player-name";
      name.textContent = j.nom;
      left.appendChild(name);

      if (j.equipeId && state.teams && state.teams.length > 0) {
        const team = state.teams.find((t) => t.id === j.equipeId);
        if (team) {
          const teamBadge = document.createElement("span");
          teamBadge.style.marginLeft = "6px";
          teamBadge.style.padding = "2px 6px";
          teamBadge.style.borderRadius = "999px";
          teamBadge.style.fontSize = "0.7rem";
          teamBadge.style.fontWeight = "600";
          teamBadge.style.backgroundColor = team.color || "#444";
          teamBadge.style.color = "#000";
          teamBadge.style.textTransform = "uppercase";
          teamBadge.textContent = team.tag || "EQ";

          left.appendChild(teamBadge);
        }
      }

      topLine.appendChild(left);

      if (j.incidentActif && j.incidentLabel) {
        const inc = document.createElement("div");
        inc.className = "player-incidents";
        inc.textContent = `‚ö† ${j.incidentLabel}`;
        topLine.appendChild(inc);
      }

      row.appendChild(topLine);

      const badges = document.createElement("div");
      badges.className = "player-maillots";

      const badgeJaune = document.createElement("div");
      badgeJaune.className = "badge";
      const dotJ = document.createElement("span");
      dotJ.className = "badge-yellow-dot";
      const labelJ = document.createElement("span");

      if (j.tempsCumul√© === leader) {
        labelJ.textContent = "üü° leader";
      } else {
        const delta = j.tempsCumul√© - leader;
        labelJ.textContent = formatDeltaSeconds(delta);
      }
      badgeJaune.appendChild(dotJ);
      badgeJaune.appendChild(labelJ);
      badges.appendChild(badgeJaune);

      const badgeVert = document.createElement("div");
      badgeVert.className = "badge";
      const dotV = document.createElement("span");
      dotV.className = "badge-green-dot";
      const labelV = document.createElement("span");
      labelV.textContent = `${j.pointsVert} pts`;
      badgeVert.appendChild(dotV);
      badgeVert.appendChild(labelV);
      badges.appendChild(badgeVert);

      const badgePois = document.createElement("div");
      badgePois.className = "badge";
      const dotP = document.createElement("span");
      dotP.className = "badge-red-dot";
      const labelP = document.createElement("span");
      labelP.textContent = `${j.pointsPois} pts`;
      badgePois.appendChild(dotP);
      badgePois.appendChild(labelP);
      badges.appendChild(badgePois);

      const badgeBlanc = document.createElement("div");
      badgeBlanc.className = "badge";
      const dotB = document.createElement("span");
      dotB.className = "badge-white-dot";
      const labelB = document.createElement("span");
      labelB.textContent = `${j.pointsBlanc} pts`;
      badgeBlanc.appendChild(dotB);
      badgeBlanc.appendChild(labelB);
      badges.appendChild(badgeBlanc);

      row.appendChild(badges);

      const actions = document.createElement("div");
      actions.className = "player-actions";
      const btn = document.createElement("button");
      btn.className = "btn-fini";
      btn.textContent = "Fini";

      btn.disabled = !state.pinteEnCours || j.aFiniCettePinte;

      btn.addEventListener("click", () => {
        handlePlayerFinish(j.id);
      });

      actions.appendChild(btn);
      row.appendChild(actions);

      elPlayersCard.appendChild(row);
    });

    renderTeams();
    renderCorrections();
  }

  function renderCorrections() {
    if (!elCorrectionsCard || !elCorrectionsBody) return;

    const playersWithStage = state.joueurs.filter((j) => j.lastStageNet !== undefined);
    if (playersWithStage.length === 0) {
      elCorrectionsCard.style.display = "none";
      elCorrectionsBody.innerHTML = "";
      return;
    }

    elCorrectionsCard.style.display = "block";
    elCorrectionsBody.innerHTML = "";

    playersWithStage.forEach((j) => {
      const row = document.createElement("div");
      row.className = "corrections-row";

      const name = document.createElement("div");
      name.textContent = j.nom;

      const actual = document.createElement("div");
      actual.textContent = formatClockTime(j.lastFinishTimestamp);

      const lastStage = document.createElement("div");
      lastStage.textContent = formatSecondsShort(j.lastStageNet);

      const inputWrap = document.createElement("div");
      const input = document.createElement("input");
      input.type = "number";
      input.min = "0";
      input.step = "1";
      input.value = Math.round(j.lastStageNet || 0);
      input.dataset.playerId = j.id;
      inputWrap.appendChild(input);

      const btn = document.createElement("button");
      btn.textContent = "Appliquer";
      btn.addEventListener("click", () => {
        const nextVal = parseFloat(input.value);
        if (Number.isNaN(nextVal) || nextVal < 0) {
          setEventZone("Correction", "Temps invalide.");
          return;
        }

        const previous = j.lastStageNet || 0;
        const diff = nextVal - previous;
        j.lastStageNet = nextVal;
        j.tempsCumul√© += diff;
        renderPlayers();
        setEventZone(
          "Correction appliqu√©e",
          `Temps ajust√© pour ${j.nom}: ${formatSecondsShort(previous)} ‚Üí ${formatSecondsShort(nextVal)}.`
        );
      });

      row.appendChild(name);
      row.appendChild(actual);
      row.appendChild(lastStage);
      row.appendChild(inputWrap);
      row.appendChild(btn);

      elCorrectionsBody.appendChild(row);
    });
  }

  function renderTeams() {
    if (!elTeamsCard) return;

    if (!state.teams || state.teams.length === 0) {
      elTeamsCard.style.display = "none";
      elTeamsCard.innerHTML = "";
      return;
    }

    const statsMap = new Map();
    state.teams.forEach((t) => {
      statsMap.set(t.id, {
        team: t,
        totalTemps: 0,
        totalVerts: 0,
        totalPois: 0,
        totalBlancs: 0,
        nbJoueurs: 0
      });
    });

    state.joueurs.forEach((j) => {
      if (!j.equipeId || !statsMap.has(j.equipeId)) return;
      const s = statsMap.get(j.equipeId);
      s.totalTemps += j.tempsCumul√©;
      s.totalVerts += j.pointsVert;
      s.totalPois += j.pointsPois;
      s.totalBlancs += j.pointsBlanc;
      s.nbJoueurs += 1;
    });

    let stats = Array.from(statsMap.values()).filter((s) => s.nbJoueurs > 0);
    if (stats.length === 0) {
      elTeamsCard.style.display = "none";
      elTeamsCard.innerHTML = "";
      return;
    }

    stats.forEach((s) => {
      s.avgTemps = s.totalTemps / s.nbJoueurs;
    });
    stats.sort((a, b) => a.avgTemps - b.avgTemps);

    const bestAvg = stats[0].avgTemps;

    let html = "";

    stats.forEach((s, idx) => {
      const delta = s.avgTemps - bestAvg;
      const deltaStr = idx === 0 ? "leader" : formatDeltaSeconds(delta);

      html += `
        <div class="player-row">
          <div class="player-top-line">
            <div style="display:flex; align-items:center;">
              <div class="player-rank">${idx + 1}.</div>
              <div class="player-name">
                <span style="
                  display:inline-flex;
                  align-items:center;
                  padding:2px 8px;
                  border-radius:999px;
                  font-size:0.75rem;
                  font-weight:700;
                  margin-right:6px;
                  background:${s.team.color || "#444"};
                  color:#000;
                  text-transform:uppercase;
                ">
                  ${s.team.tag || "EQ"}
                </span>
                ${s.team.name || "√âquipe"}
              </div>
            </div>
            <div style="font-size:0.8rem; color:var(--text-muted);">
              ${deltaStr}
            </div>
          </div>

          <div class="player-maillots">
            <div class="badge">
              <span class="badge-green-dot"></span>
              <span>${s.totalVerts} pts</span>
            </div>
            <div class="badge">
              <span class="badge-red-dot"></span>
              <span>${s.totalPois} pts</span>
            </div>
            <div class="badge">
              <span class="badge-white-dot"></span>
              <span>${s.totalBlancs} pts</span>
            </div>
          </div>
        </div>
      `;
    });

    elTeamsCard.innerHTML = html;
    elTeamsCard.style.display = "block";
  }

  function handlePlayerFinish(joueurId) {
    if (!state.pinteEnCours) return;

    const joueur = state.joueurs.find((j) => j.id === joueurId);
    if (!joueur) return;
    if (joueur.aFiniCettePinte) return;

    const t = nowSeconds();
    joueur.aFiniCettePinte = true;
    joueur.lastFinishTimestamp = t;
    state.finPinteOrdre.push({ joueurId, timestamp: t });

    setEventZone(
      "Arriv√©e enregistr√©e",
      `${joueur.nom} a termin√© sa pinte. Quand tout le monde a fini, le classement de l‚Äô√©tape sera calcul√©.`
    );

    const allFinished = state.joueurs.every((j) => j.aFiniCettePinte);
    if (allFinished) {
      finalizeStage();
    } else {
      renderPlayers();
    }
  }

  function finalizeStage() {
    if (state.finPinteOrdre.length === 0) return;

    const classement = [...state.finPinteOrdre].sort((a, b) => a.timestamp - b.timestamp);
    const t0 = classement[0].timestamp;
    const bonus = [5, 2, 1];

    let resumeEtape = "R√©sultat de l‚Äô√©tape :\n";

    classement.forEach((entry, idx) => {
      const joueur = state.joueurs.find((j) => j.id === entry.joueurId);
      if (!joueur) return;

      const brut = entry.timestamp - t0;
      const b = idx < bonus.length ? bonus[idx] : 0;
      let net = brut - b;
      if (net < 0) net = 0;

      joueur.tempsCumul√© += net;
      joueur.lastStageNet = net;
      joueur.lastStageRaw = brut;

      const rang = idx + 1;
      const deltaStr = formatDeltaSeconds(brut);
      const netStr = formatDeltaSeconds(net);

      resumeEtape += `${rang}. ${joueur.nom} (${deltaStr}, bonif -${b}\", net ${netStr})\n`;
    });

    state.pinteEnCours = true;
    state.finPinteOrdre = [];
    state.joueurs.forEach((j) => {
      j.aFiniCettePinte = false;
    });

    state.numeroPinte += 1;
    state.lastStageIndex += 1;
    cleanExpiredIncidents();

    renderPlayers();

    setEventZone("√âtape termin√©e", resumeEtape.trim());

    if (supabaseClient && state.roomId && state.dataMode === "pinte_finishes") {
      supabaseClient.from("rooms").update({
        pint_no: state.numeroPinte
      }).eq("id", state.roomId);
    }
  }

  function renderSprintInterface() {
    const html = [];

    html.push('<div class="event-title">‚ö° SPRiNT !</div>');
    html.push('<div class="event-body">Classez les joueurs dans l\'ordre d\'arriv√©e :</div>');

    html.push('<div style="margin-top:10px;">');
    state.joueurs.forEach((j) => {
      html.push(`
        <div style="margin-bottom:8px;">
          <label style="font-size:0.85rem;">${j.nom}</label>
          <select id="sprint-${j.id}" class="form-select">
            ${state.joueurs.map((_, i) => `<option value="${i + 1}">${i + 1}</option>`).join("")}
          </select>
        </div>
      `);
    });
    html.push("</div>");

    html.push(`
      <button id="btn-valider-sprint" class="btn-primary" style="margin-top:12px;">
        Valider le sprint
      </button>
    `);

    document.getElementById("event-zone").innerHTML = html.join("");

    document.getElementById("btn-valider-sprint").addEventListener("click", validerSprint);
  }

  function validerSprint() {
    const classements = [];

    state.joueurs.forEach((j) => {
      const rank = parseInt(document.getElementById(`sprint-${j.id}`).value, 10);
      classements.push({ id: j.id, rank });
    });

    classements.sort((a, b) => a.rank - b.rank);

    const points = [10, 6, 4, 3, 2, 1];
    const bonifs = [25, 15, 10];
    let result = "R√©sultats du Sprint :\n\n";

    classements.forEach((entry, idx) => {
      const joueur = state.joueurs.find((j) => j.id === entry.id);
      const p = points[idx] || 1;
      joueur.pointsVert += p;
      const bonif = bonifs[idx] || 0;
      if (bonif > 0) {
        joueur.tempsCumul√© = Math.max(0, joueur.tempsCumul√© - bonif);
      }
      result += `${idx + 1}. ${joueur.nom} (+${p} pts${bonif ? `, -${bonif}s` : ""})\n`;
    });

    sprintActif = false;
    sprintCooldown = nowSeconds() + 900;
    sprintLanceur = null;

    renderPlayers();
    setEventZone("Sprint termin√©", result.trim());
  }

  function renderCoteInterface() {
    const html = [];

    html.push('<div class="event-title">‚õ∞Ô∏è C√¥te</div>');
    html.push(`<div class="event-body">Grimpez et arr√™tez-vous √† <b>${coteCible}%</b>. Quand tout le monde a stopp√©, appuyez sur le bouton.</div>`);

    html.push(`
      <button id="btn-cote-stop" class="btn-primary" style="margin-top:12px;">
        Tout le monde a stopp√©
      </button>
    `);

    document.getElementById("event-zone").innerHTML = html.join("");

    document.getElementById("btn-cote-stop").addEventListener("click", renderCoteClassement);
  }

  function renderCoteClassement() {
    const html = [];

    html.push('<div class="event-title">Classement de la C√¥te</div>');
    html.push('<div class="event-body">Classez les grimpeurs du plus pr√©cis au moins pr√©cis :</div>');

    html.push('<div style="margin-top:10px;">');
    state.joueurs.forEach((j) => {
      html.push(`
        <div style="margin-bottom:8px;">
          <label style="font-size:0.85rem;">${j.nom}</label>
          <select id="cote-${j.id}" class="form-select">
            ${state.joueurs.map((_, i) => `<option value="${i + 1}">${i + 1}</option>`).join("")}
          </select>
        </div>
      `);
    });
    html.push("</div>");

    html.push(`
      <button id="btn-valider-cote" class="btn-primary" style="margin-top:12px;">
        Valider la C√¥te
      </button>
    `);

    document.getElementById("event-zone").innerHTML = html.join("");

    document.getElementById("btn-valider-cote").addEventListener("click", validerCote);
  }

  function validerCote() {
    const classements = [];

    state.joueurs.forEach((j) => {
      const rank = parseInt(document.getElementById(`cote-${j.id}`).value, 10);
      classements.push({ id: j.id, rank });
    });

    classements.sort((a, b) => a.rank - b.rank);

    const points = [8, 5, 3, 2, 1, 1, 1];

    let recap = "R√©sultats de la C√¥te :\n\n";

    classements.forEach((entry, idx) => {
      const joueur = state.joueurs.find((j) => j.id === entry.id);
      const p = points[idx] || 1;
      joueur.pointsPois += p;
      recap += `${idx + 1}. ${joueur.nom} (+${p} pts)\n`;
    });

    coteActive = false;
    coteCible = null;

    renderPlayers();

    const html = `
      <div class="event-title">C√¥te termin√©e</div>
      <div class="event-body">${recap}</div>

      <button id="btn-cote-ok" class="btn-primary" style="margin-top:12px;">
        OK
      </button>
    `;

    document.getElementById("event-zone").innerHTML = html;

    document.getElementById("btn-cote-ok").addEventListener("click", () => {
      setEventZone("Aucun √©v√©nement en cours", "Quand une pinte est termin√©e, appuie sur ¬´ Fini ¬ª." );
    });
  }

  function renderEchappeeInterface() {
    const html = [];

    html.push('<div class="event-title">üö¥ √âchapp√©e</div>');
    html.push('<div class="event-body">Le plus rapide gagne ! Touchez votre bouton d√®s qu\'il appara√Æt :</div>');

    html.push('<div style="margin-top:12px;">');

    state.joueurs.forEach((j) => {
      html.push(`
        <button id="echappee-${j.id}" class="btn-primary" style="width:100%; margin-bottom:8px; background:#ffffff; color:#000;">
          ${j.nom}
        </button>
      `);
    });

    html.push("</div>");

    document.getElementById("event-zone").innerHTML = html.join("");

    state.joueurs.forEach((j) => {
      document.getElementById(`echappee-${j.id}`).addEventListener("click", () => {
        handleEchappeeClick(j.id);
      });
    });
  }

  function handleEchappeeClick(joueurId) {
    if (!echappeeActive) return;

    echappeeClics.push({
      id: joueurId,
      t: nowSeconds()
    });

    if (echappeeClics.length === state.joueurs.length) {
      finalizeEchappee();
    }
  }

  function finalizeEchappee() {
    echappeeActive = false;

    echappeeClics.sort((a, b) => a.t - b.t);

    const points = [3, 1];
    let recap = "R√©sultats de l'√©chapp√©e :\n\n";

    echappeeClics.forEach((entry, idx) => {
      const joueur = state.joueurs.find((j) => j.id === entry.id);
      const p = points[idx] || 0;
      joueur.pointsBlanc += p;
      recap += `${idx + 1}. ${joueur.nom} (+${p} pts)\n`;
    });

    renderPlayers();

    const html = `
      <div class="event-title">√âchapp√©e termin√©e</div>
      <div class="event-body">${recap}</div>

      <button id="btn-echappee-ok" class="btn-primary" style="margin-top:12px;">
        OK
      </button>
    `;

    document.getElementById("event-zone").innerHTML = html;

    document.getElementById("btn-echappee-ok").addEventListener("click", () => {
      setEventZone("Aucun √©v√©nement en cours", "Quand une pinte est termin√©e, appuie sur ¬´ Fini ¬ª." );
    });
  }

  function renderIncidentInterface() {
    const inc = incidentData;

    let target = null;
    if (inc.type === "player") {
      const idx = Math.floor(Math.random() * state.joueurs.length);
      target = state.joueurs[idx];
    }

    let html = '<div class="event-title">‚ö†Ô∏è Incident</div>';

    if (inc.type === "player") {
      html += `<div class="event-body"><b>${inc.label}</b>\n\nCible : <b>${target.nom}</b></div>`;
    } else if (inc.type === "all") {
      html += `<div class="event-body"><b>${inc.label}</b>\n\nTous les joueurs sont concern√©s.</div>`;
    } else {
      html += `<div class="event-body"><b>${inc.label}</b>\n\nImpact gameplay.</div>`;
    }

    html += `
      <button id="btn-incident-ok" class="btn-primary" style="margin-top:12px;">
        OK
      </button>
    `;

    document.getElementById("event-zone").innerHTML = html;

    document.getElementById("btn-incident-ok").addEventListener("click", () => {
      if (inc.type === "player") {
        target.incidentActif = true;
        target.incidentLabel = inc.label;

        if (inc.duration === "1-pinte") {
          target.incidentExpirePinte = state.numeroPinte;
        }
        if (inc.duration === "5-min") {
          target.incidentExpireTimestamp = nowSeconds() + 300;
        }
      }

      if (inc.type === "all") {
        state.joueurs.forEach((j) => {
          j.incidentActif = true;
          j.incidentLabel = inc.label;

          if (inc.duration === "1-pinte") {
            j.incidentExpirePinte = state.numeroPinte;
          }
          if (inc.duration === "5-min") {
            j.incidentExpireTimestamp = nowSeconds() + 300;
          }
        });
      }

      renderPlayers();

      incidentActif = false;
      incidentData = null;

      setEventZone("Aucun √©v√©nement en cours", "Quand une pinte est termin√©e, appuie sur ¬´ Fini ¬ª.");
    });
  }

  function cleanExpiredIncidents() {
    const now = nowSeconds();

    state.joueurs.forEach((j) => {
      if (j.incidentExpirePinte !== null) {
        if (j.incidentExpirePinte < state.numeroPinte) {
          j.incidentActif = false;
          j.incidentLabel = null;
          j.incidentExpirePinte = null;
        }
      }

      if (j.incidentExpireTimestamp !== null) {
        if (now >= j.incidentExpireTimestamp) {
          j.incidentActif = false;
          j.incidentLabel = null;
          j.incidentExpireTimestamp = null;
        }
      }
    });
  }

  async function createRoom() {
    if (!supabaseClient) return null;

    try {
      await ensureSignedIn();
    } catch (error) {
      showSupabaseError("Connexion impossible. V√©rifiez l'URL et la cl√© anon.");
      return null;
    }

    for (let attempt = 0; attempt < 5; attempt += 1) {
      const code = generateRoomCode(6);

      const { data: rpcData, error: rpcError } = await supabaseClient.rpc("create_room", {
        p_code: code,
        p_duree_minutes: state.dureeMinutes,
        p_difficulte: state.difficulte,
        p_display_name: "Host"
      });

      if (!rpcError && rpcData) {
        state.dataMode = "pinte_finishes";
        return { id: rpcData, code };
      }

      if (rpcError) {
        showSupabaseError(
          `Erreur RPC create_room: ${rpcError.message || "inconnue"}. V√©rifiez vos policies/auth.`
        );
        return null;
      }

      const { data, error } = await supabaseClient
        .from("rooms")
        .insert({ code })
        .select("id, code")
        .single();

      if (!error && data) {
        state.dataMode = "events";
        return data;
      }
    }

    return null;
  }

  function updateRoomCodeUI(code) {
    if (elRoomCodeValue) {
      elRoomCodeValue.textContent = code || "‚Äî";
    }
  }

  async function setupHostRoom() {
    if (!supabaseClient) {
      elSupabaseWarning.style.display = "block";
      updateRoomCodeUI("OFFLINE");
      return;
    }

    elSupabaseWarning.style.display = "none";
    if (elSupabaseStatus) {
      elSupabaseStatus.style.display = "none";
      elSupabaseStatus.textContent = "";
    }
    let room = null;
    room = await createRoom();

    if (!room) {
      updateRoomCodeUI("ERR");
      showSupabaseError(
        "Impossible de cr√©er la salle. V√©rifiez l'URL/cl√©, les policies RLS et que l'auth anonyme est activ√©e."
      );
      return;
    }

    state.roomId = room.id;
    state.roomCode = room.code;
    updateRoomCodeUI(room.code);

    subscribeToRoom();
  }

  async function fetchProfileName(userId) {
    if (!supabaseClient || !userId) return null;
    if (state.memberNameCache.has(userId)) return state.memberNameCache.get(userId);

    const { data, error } = await supabaseClient
      .from("profiles")
      .select("display_name")
      .eq("user_id", userId)
      .single();

    if (error || !data) return null;
    state.memberNameCache.set(userId, data.display_name);
    return data.display_name;
  }

  function subscribeToRoom() {
    if (!supabaseClient || !state.roomId) return;

    if (state.roomSubscription) {
      supabaseClient.removeChannel(state.roomSubscription);
    }
    if (state.eventSubscription) {
      supabaseClient.removeChannel(state.eventSubscription);
    }

    const channel = supabaseClient
      .channel(`room-${state.roomId}`)
      .on(
        "postgres_changes",
        {
          event: "INSERT",
          schema: "public",
          table: state.dataMode === "pinte_finishes" ? "pinte_finishes" : "events",
          filter: `room_id=eq.${state.roomId}`
        },
        async (payload) => {
          if (!payload.new) return;
          if (state.dataMode === "events" && payload.new.type !== "finish") return;

          let playerName = "";
          if (state.dataMode === "events") {
            playerName = payload.new.payload?.playerName || "";
          } else {
            playerName = await fetchProfileName(payload.new.user_id);
          }

          const normalized = (playerName || "").trim().toLowerCase();
          if (!normalized) return;

          if (!recordFinish(normalized)) return;

          const joueur = state.joueurs.find((j) => j.nom.toLowerCase() === normalized);
          if (!joueur) {
            setEventZone("Signal joueur inconnu", `${playerName} n'existe pas dans la liste.`);
            return;
          }

          handlePlayerFinish(joueur.id);
        }
      )
      .subscribe();

    state.roomSubscription = channel;

    if (state.dataMode === "pinte_finishes") {
      const eventChannel = supabaseClient
        .channel(`room-events-${state.roomId}`)
        .on(
          "postgres_changes",
          {
            event: "INSERT",
            schema: "public",
            table: "events",
            filter: `room_id=eq.${state.roomId}`
          },
          (payload) => {
            if (!payload.new || payload.new.type !== "finish") return;
            const playerName = payload.new.payload?.playerName || "";
            const normalized = playerName.trim().toLowerCase();
            if (!normalized) return;
            if (!recordFinish(normalized)) return;
            const joueur = state.joueurs.find((j) => j.nom.toLowerCase() === normalized);
            if (!joueur) {
              setEventZone("Signal joueur inconnu", `${playerName} n'existe pas dans la liste.`);
              return;
            }
            handlePlayerFinish(joueur.id);
          }
        )
        .subscribe();

      state.eventSubscription = eventChannel;
    }
  }

  async function joinRoomAsPlayer() {
    if (!supabaseClient) {
      elPlayerStatus.textContent = "Supabase non configur√©. Mode Player indisponible.";
      return;
    }

    const code = elPlayerRoomCode.value.trim().toUpperCase();
    const name = elPlayerName.value.trim();

    if (!code) {
      elPlayerStatus.textContent = "Merci de saisir un code de salle valide.";
      return;
    }
    if (!name) {
      elPlayerStatus.textContent = "Merci de saisir ton pr√©nom.";
      return;
    }

    elPlayerStatus.textContent = "Connexion √† la salle...";

    try {
      await ensureSignedIn();
    } catch (error) {
      elPlayerStatus.textContent = "Connexion Supabase impossible.";
      return;
    }

    const { data: rpcData, error: rpcError } = await supabaseClient.rpc("join_room", {
      p_code: code,
      p_display_name: name
    });

    if (!rpcError && rpcData) {
      state.roomId = rpcData;
      state.roomCode = code;
      state.dataMode = "pinte_finishes";
      elPlayerStatus.textContent = `Salle ${code} rejointe.`;
    } else {
      const { data, error } = await supabaseClient
        .from("rooms")
        .select("id, code")
        .eq("code", code)
        .single();

      if (error || !data) {
        elPlayerStatus.textContent = "Code invalide ou salle introuvable.";
        return;
      }

      state.roomId = data.id;
      state.roomCode = data.code;
      state.dataMode = "events";
      elPlayerStatus.textContent = `Salle ${data.code} rejointe.`;
    }

    elBtnPlayerJoin.disabled = true;
    elBtnPlayerFinish.style.display = "block";
  }

  async function sendFinishEvent() {
    if (!supabaseClient || !state.roomId) {
      elPlayerStatus.textContent = "Impossible d'envoyer l'√©v√©nement.";
      return;
    }

    const name = elPlayerName.value.trim();
    if (!name) {
      elPlayerStatus.textContent = "Merci de saisir ton pr√©nom.";
      return;
    }

    try {
      await ensureSignedIn();
    } catch (error) {
      elPlayerStatus.textContent = `Connexion Supabase impossible: ${error.message || "auth"}.`;
      return;
    }

    let error = null;

    if (state.dataMode === "pinte_finishes") {
      const { data: roomData } = await supabaseClient
        .from("rooms")
        .select("pint_no")
        .eq("id", state.roomId)
        .single();
      const pintNo = roomData?.pint_no || 1;

      const { data: sessionData } = await supabaseClient.auth.getSession();
      const userId = sessionData?.session?.user?.id;
      if (!userId) {
        elPlayerStatus.textContent = "Session invalide. Rejoins la salle √† nouveau.";
        return;
      }
      const { error: insertError } = await supabaseClient
        .from("pinte_finishes")
        .upsert(
          {
            room_id: state.roomId,
            pint_no: pintNo,
            user_id: userId
          },
          { onConflict: "room_id,pint_no,user_id", ignoreDuplicates: true }
        );
      error = insertError;

      if (!error) {
        await supabaseClient.from("events").insert({
          room_id: state.roomId,
          type: "finish",
          payload: { playerName: name }
        });
      }
    } else {
      const { error: insertError } = await supabaseClient.from("events").insert({
        room_id: state.roomId,
        type: "finish",
        payload: { playerName: name }
      });
      error = insertError;
    }

    if (error) {
      elPlayerStatus.textContent = `Erreur Supabase: ${error.message || "r√©essaie"}.`;
      return;
    }

    elPlayerStatus.textContent = "Arriv√©e envoy√©e !";
    elBtnPlayerFinish.disabled = true;
    setTimeout(() => {
      elBtnPlayerFinish.disabled = false;
    }, 8000);
  }

  document.getElementById("btn-sprint").addEventListener("click", () => {
    if (sprintActif) {
      setEventZone("Sprint impossible", "Un sprint est d√©j√† en cours !");
      return;
    }

    const now = nowSeconds();
    if (now < sprintCooldown) {
      const remaining = Math.ceil(sprintCooldown - now);
      setEventZone("Sprint refus√©", `Il faut encore attendre ${remaining} secondes avant de relancer un sprint.`);
      return;
    }

    const noms = state.joueurs.map((j) => j.nom).join("\n");
    const who = prompt("Qui lance le sprint ?\n\n" + noms);

    if (!who) return;

    const lanceur = state.joueurs.find((j) => j.nom.toLowerCase() === who.toLowerCase());
    if (!lanceur) {
      setEventZone("Erreur", "Nom introuvable.");
      return;
    }

    if (!lanceur.sprintsLances) lanceur.sprintsLances = 0;
    if (lanceur.sprintsLances >= 2) {
      setEventZone("Sprint refus√©", `${lanceur.nom} a d√©j√† lanc√© 2 sprints.`);
      return;
    }

    lanceur.sprintsLances += 1;
    sprintLanceur = lanceur.id;
    sprintActif = true;

    renderSprintInterface();
  });

  document.getElementById("btn-cote").addEventListener("click", () => {
    if (coteActive) {
      setEventZone("C√¥te impossible", "Une c√¥te est d√©j√† en cours !");
      return;
    }

    coteCible = Math.floor(20 + Math.random() * 60);
    coteActive = true;

    renderCoteInterface();
  });

  document.getElementById("btn-echappee").addEventListener("click", () => {
    if (echappeeActive) {
      setEventZone("√âchapp√©e impossible", "Une √©chapp√©e est d√©j√† en cours !");
      return;
    }

    echappeeActive = true;
    echappeeClics = [];

    renderEchappeeInterface();
  });

  document.getElementById("btn-incident").addEventListener("click", () => {
    if (incidentActif) {
      setEventZone("Incident en cours", "Veuillez terminer l'incident actuel avant d'en tirer un autre.");
      return;
    }

    const incident = incidentsList[Math.floor(Math.random() * incidentsList.length)];
    incidentActif = true;
    incidentData = incident;

    renderIncidentInterface();
  });

  if (elTeamsEnabled) {
    elTeamsEnabled.addEventListener("change", () => {
      if (elTeamsEnabled.checked) {
        elTeamsSetup.style.display = "block";
        refreshTeamsAssignmentUI();
      } else {
        elTeamsSetup.style.display = "none";
        elTeamsAssignment.innerHTML = "";
      }
    });
  }

  if (elBtnRefreshTeams) {
    elBtnRefreshTeams.addEventListener("click", () => {
      refreshTeamsAssignmentUI();
    });
  }

  elBtnDemo.addEventListener("click", () => {
    elPlayersInput.value = "Louis\nEloi\nGabriel\nLo√Øc\nMax";
    elSetupError.textContent = "";
    if (elTeamsEnabled && elTeamsEnabled.checked) {
      refreshTeamsAssignmentUI();
    }
  });

  elBtnStart.addEventListener("click", () => {
    const minutes = parseInt(elDuration.value, 10);
    const rawNames = elPlayersInput.value
      .split("\n")
      .map((s) => s.trim())
      .filter((s) => s.length > 0);
    const selectedProfile = document.querySelector('input[name="profil-etape"]:checked');
    state.difficulte = selectedProfile ? selectedProfile.value : "Plaine";

    const teamsEnabled = elTeamsEnabled && elTeamsEnabled.checked;
    state.teams = [];

    if (teamsEnabled) {
      const name1 = (elTeam1Name.value || "").trim() || "√âquipe 1";
      const tag1 = ((elTeam1Tag.value || "").trim() || "EQ1").toUpperCase();
      const color1 = elTeam1Color.value || "#FFD600";

      const name2 = (elTeam2Name.value || "").trim() || "√âquipe 2";
      const tag2 = ((elTeam2Tag.value || "").trim() || "EQ2").toUpperCase();
      const color2 = elTeam2Color.value || "#00AEEF";

      state.teams = [
        { id: 1, name: name1, tag: tag1, color: color1 },
        { id: 2, name: name2, tag: tag2, color: color2 }
      ];
    }

    if (rawNames.length < 2) {
      elSetupError.textContent = "Il faut au moins 2 joueurs pour lancer le Tour.";
      return;
    }
    if (rawNames.length > 10) {
      elSetupError.textContent = "Maximum 10 joueurs.";
      return;
    }

    state.joueurs = rawNames.map((nom, idx) => {
      let equipeId = null;

      if (teamsEnabled && state.teams.length > 0) {
        const select = document.getElementById(`team-assign-${idx}`);
        if (select && select.value) {
          const val = parseInt(select.value, 10);
          if (!isNaN(val)) {
            equipeId = val;
          }
        }
      }

      return {
        id: idx + 1,
        nom,
        tempsCumul√©: 0,
        pointsVert: 0,
        pointsPois: 0,
        pointsBlanc: 0,
        incidentActif: false,
        incidentLabel: null,
        incidentExpirePinte: null,
        incidentExpireTimestamp: null,
        aFiniCettePinte: false,
        equipeId: equipeId
      };
    });

    state.dureeMinutes = minutes;
    state.tourStartTimestamp = nowSeconds();
    state.tourFinTimestamp = state.tourStartTimestamp + minutes * 60;
    state.stageStartTimestamp = state.tourStartTimestamp;
    state.pinteEnCours = true;
    state.finPinteOrdre = [];
    state.numeroPinte = 1;
    state.lastStageIndex = 0;
    state.finishSignals.clear();

    const occ = computeOccurrences(state.dureeMinutes, state.difficulte);
    state.timelineEvents = buildTimeline(state.dureeMinutes, occ);

    if (state.timerInterval) {
      clearInterval(state.timerInterval);
    }
    state.timerInterval = setInterval(tickTimer, 1000);
    tickTimer();

    elSetupModal.style.display = "none";
    renderPlayers();
    setEventZone(
      "Tour lanc√©",
      "La premi√®re pinte est en cours. Appuie sur ¬´ Fini ¬ª quand un joueur termine sa pinte pour mettre √† jour le Maillot Jaune."
    );

    if (supabaseClient && state.roomId && state.dataMode === "pinte_finishes") {
      supabaseClient.from("rooms").update({
        status: "live",
        tour_start: new Date().toISOString(),
        duree_minutes: state.dureeMinutes,
        difficulte: state.difficulte,
        pint_no: state.numeroPinte
      }).eq("id", state.roomId);
    }
  });

  elBtnSettings.addEventListener("click", () => {
    ouvrirClassements();
  });

  elBtnClassementClose.addEventListener("click", () => {
    elClassementModal.style.display = "none";
  });

  elCopyRoom.addEventListener("click", async () => {
    if (!state.roomCode) return;
    try {
      await navigator.clipboard.writeText(state.roomCode);
      elCopyRoom.textContent = "Copi√©";
      setTimeout(() => {
        elCopyRoom.textContent = "Copier";
      }, 1200);
    } catch (error) {
      setEventZone("Copie impossible", "Impossible de copier automatiquement le code salle.");
    }
  });

  elBtnModeHost.addEventListener("click", async () => {
    elCoverScreen.style.opacity = "0";
    setTimeout(() => {
      elCoverScreen.style.display = "none";
    }, 400);

    elMainContent.style.display = "block";
    elPlayerContent.style.display = "none";

    if (!supabaseReady) {
      elSupabaseWarning.style.display = "block";
      updateRoomCodeUI("OFFLINE");
    } else {
      await setupHostRoom();
    }
  });

  elBtnModePlayer.addEventListener("click", () => {
    elCoverScreen.style.opacity = "0";
    setTimeout(() => {
      elCoverScreen.style.display = "none";
    }, 400);

    elMainContent.style.display = "none";
    elPlayerContent.style.display = "block";

    if (!supabaseReady) {
      elPlayerStatus.textContent = "Supabase non configur√©. Mode Player indisponible.";
      elBtnPlayerJoin.disabled = true;
    }
  });

  elBtnPlayerJoin.addEventListener("click", () => {
    joinRoomAsPlayer();
  });

  elBtnPlayerFinish.addEventListener("click", () => {
    sendFinishEvent();
  });

  elBtnConfigSupabase.addEventListener("click", () => {
    elSupabaseConfigError.textContent = "";
    elSupabaseUrlInput.value = localStorage.getItem("supabaseUrl") || "";
    elSupabaseKeyInput.value = localStorage.getItem("supabaseAnonKey") || "";
    elSupabaseConfigModal.style.display = "flex";
  });

  elBtnCloseSupabase.addEventListener("click", () => {
    elSupabaseConfigModal.style.display = "none";
  });

  elBtnSaveSupabase.addEventListener("click", () => {
    const url = elSupabaseUrlInput.value.trim();
    const key = elSupabaseKeyInput.value.trim();

    if (!url || !key) {
      elSupabaseConfigError.textContent = "URL et cl√© sont obligatoires.";
      return;
    }

    localStorage.setItem("supabaseUrl", url);
    localStorage.setItem("supabaseAnonKey", key);

    SUPABASE_CONFIG = loadSupabaseConfig();
    supabaseReady = isSupabaseReady(SUPABASE_CONFIG);
    supabaseClient = supabaseReady ? supabase.createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.anonKey) : null;

    elSupabaseConfigModal.style.display = "none";
    location.reload();
  });

  const elProfilRadios = document.querySelectorAll('input[name="profil-etape"]');
  elProfilRadios.forEach((radio) => {
    radio.addEventListener("change", () => {
      if (radio.checked) {
        state.difficulte = radio.value;
      }
    });
  });

  renderPlayers();
</script>

<!-- SQL & RLS (pour tests rapides, RLS peut √™tre d√©sactiv√© temporairement) -->
<script type="text/plain" id="supabase-sql">
-- Tables
create table if not exists public.rooms (
  id uuid primary key default gen_random_uuid(),
  code text unique not null,
  created_at timestamptz not null default now()
);

create table if not exists public.events (
  id bigint generated by default as identity primary key,
  room_id uuid not null references public.rooms(id) on delete cascade,
  type text not null,
  payload jsonb not null default '{}'::jsonb,
  created_at timestamptz not null default now()
);

-- RLS (d√©sactivez pour tester rapidement, mais r√©activez en prod)
-- alter table public.rooms enable row level security;
-- alter table public.events enable row level security;
-- create policy "rooms read" on public.rooms for select using (true);
-- create policy "events insert" on public.events for insert with check (true);
-- create policy "events read" on public.events for select using (true);
</script>

<!-- SONS -->
<audio id="snd-sprint" src="snd/sprint.mp3" preload="auto"></audio>
<audio id="snd-cote" src="snd/cote.mp3" preload="auto"></audio>
<audio id="snd-echappee" src="snd/echappee.mp3" preload="auto"></audio>
<audio id="snd-incident" src="snd/incident.mp3" preload="auto"></audio>
</body>
</html>
